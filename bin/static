#!/usr/bin/env julia --color=yes
using Kip
@use "github.com/jkroso/SimpleCLI.jl" @CLI
import Sockets: listen, listenany, localhost, IPAddr

"""
Serve <directory> on <port>. If you don't define a port one will be selected
randomly and printed to STDOUT
"""
@CLI (directory::String; port::Integer=get(ENV,"PORT",0), addr::String="localhost")

host = addr == "localhost" ? localhost : parse(IPAddr, addr)

const p, server = if port != 0
  port, listen(host, port)
else
  listenany(host, 3000)
end

const path = abspath(directory)
const root = isdir(path) ? path : dirname(path)

# use late so we connect to the port ASAP
@use "github.com/jkroso/HTTP.jl/server" handle_requests
@use "github.com/coiljl/static" static ["transform.jl" transform]
@use "github.com/coiljl/logger" logger

const f = relpath(path, root)
run(`open http://$host:$p/$(f == "." ? "" : f)`)

handle_requests(logger(static(root, transform=transform, index="index.jl")), server)
